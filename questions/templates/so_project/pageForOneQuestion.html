{% extends "so_project/new_or_tag_Questions.html" %}
{% load static %}

{% block question__styles %}
    <link rel="stylesheet" href="{% static 'so_project/css/pageForOneQuestion.css' %}">
{% endblock question__styles %}

{% block sec__tit %}{% endblock sec__tit %}

{% block section %}
    <div class="questions__content mb-4">
        <div class="card__question p-3 border rounded">
            <div class="d-flex">
                <div class="question__aside me-3 text-center" style="width: 80px;">
                    {% include "so_project/include_blocks/vote_question_button_block.html" with show_total=True %}
                    {% if question.id_u.avatar %}
                        <img src="/media/{{ question.id_u.avatar }}" alt="avatar" class="rounded-circle" style="width: 50px; height: 50px; object-fit: cover;">
                    {% else %}
                        <img src="{% static 'so_project/img/profile.png' %}" alt="avatar" class="rounded-circle" style="width: 50px; height: 50px; object-fit: cover;">
                    {% endif %}
                </div>

                <!-- содержание вопроса -->
                <div class="question__content flex-grow-1">
                    <h3 class="question__header mb-3">{{ question.title_question }}</h3>
                    <p class="question__description mb-3">
                        {{ question.question|linebreaks }}
                    </p>
                    <div class="question__footer d-flex justify-content-between align-items-center">
                        <div class="question__tags">
                            <span class="question__tags__title"><strong>Теги:</strong></span>
                            <div class="question__tags__list d-inline ms-2">
                                {% for tag in question.tags.all %}
                                    <a href="{% url 'questions:questions_by_tag' %}?tag_name={{ tag.tag }}"
                                       class="badge bg-secondary text-decoration-none me-1">
                                        {{ tag.tag }}
                                    </a>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="question__meta text-muted">
                            Автор: {{ question.id_u.nickname }} | {{ question.created_at_question|date:"d.m.Y H:i" }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="answers__content mb-4">
        <h4 class="mb-3">Ответы ({{ answers|length }})</h4>

        {% for answer in answers %}
            <div class="card__answers mb-3 p-3 border rounded {% if answer.is_correct %}border-success bg-light{% endif %}"
                 id="answer-{{ answer.id_an }}">
                <div class="d-flex">
                    <div class="question__aside me-3 text-center" style="width: 80px;">
                        {% include "so_project/include_blocks/vote_answer_button_block.html" with show_total=True %}
                        {% if answer.id_u.avatar %}
                            <img src="/media/{{ answer.id_u.avatar }}" alt="avatar" class="rounded-circle" style="width: 50px; height: 50px; object-fit: cover;">
                        {% else %}
                            <img src="{% static 'so_project/img/profile.png' %}" alt="avatar" class="rounded-circle" style="width: 50px; height: 50px; object-fit: cover;">
                        {% endif %}
                    </div>

                    <!-- содержание ответа -->
                    <div class="question__content flex-grow-1">
                        <p class="question__description mb-3">
                            {{ answer.answers|linebreaks }}
                        </p>

                        <div class="question__footer d-flex justify-content-between align-items-center">
                            <div>
                                {% if answer.is_correct %}
                                    <span class="badge bg-success">✅ Правильный ответ</span>
                                {% elif can_mark_correct %}
                                    <button id="mark-correct-{{ answer.id_an }}"
                                            class="btn btn-outline-success btn-sm"
                                            onclick="markCorrectAnswer({{ question.id_q }}, {{ answer.id_an }})">
                                        <span>✔</span> Correct!
                                    </button>
                                {% endif %}
                            </div>

                            <div class="question__meta text-muted">
                                Автор: {{ answer.id_u.nickname }} | {{ answer.created_at_answer|date:"d.m.Y H:i" }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% empty %}
            <div class="alert alert-info">Ответов пока нет. Будьте первым!</div>
        {% endfor %}
    </div>

    <!-- Форма добавления ответа -->
    {% if user.is_authenticated %}
        <div class="section__my__answer mb-3">
            <h5>Ваш ответ</h5>
            <form method="post">
                {% csrf_token %}
                <textarea class="form-control answer__text" name="answer_text"
                          placeholder="Введите свой ответ" rows="5" required></textarea>
                <div class="button__my__answer mt-2">
                    <button type="submit" class="btn btn-primary button__answer">Ответить</button>
                </div>
            </form>
        </div>
    {% else %}
        <div class="alert alert-warning">
            Чтобы отвечать на вопросы, пожалуйста,
            <a href="{% url 'accounts:login_page' %}">войдите</a> или
            <a href="{% url 'accounts:registration_page' %}">зарегистрируйтесь</a>.
        </div>
    {% endif %}
{% endblock section %}